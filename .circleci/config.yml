version: 2.1
jobs:
  build-ros-ws:
    docker:
      - image: flyvoly/lomp:latest

    resource_class: medium

    steps:
      - checkout
      - run:
          name: Setup submodules
          command: |
            chmod 700 .ssh/key
            eval `ssh-agent`
            ssh-add .ssh/key
            git submodule sync --recursive && git submodule update --init --recursive
      - run:
          name: Build ros packages
          command: |
            source /opt/ros/melodic/setup.bash
            catkin build -j4 px4 mavlink_sitl_gazebo volys_precision_landing
      - save_cache:
          key: precision-landing-{{ .Branch }}-{{ .BuildNum }}
          paths: 
            - ~/precision-landing.bz2

  run-precision-landing-test:
    docker:
      - image: flyvoly/lomp:latest

    resource_class: large
    
    steps:
      - restore_cache:
          keys: 
            - precision-landing-{{ .Branch }}-{{ .BuildNum }}
    
      - run:
          name: Unpack SITL
          command: |
            tar -xjpvf ~/precision-landing.bz2
            mv px4-precision-landing* precision-landing/
      
      - run:
          name: Run VTOL Mission
          command: |
            export SITL_RUN_SH="precision-landing/src/px4_firmware/px4/test/rostest_px4_run.sh"
            export PX4_HOME_LAT=37.994068
            export PX4_HOME_LON=-122.0614603
            export PX4_HOME_ALT=0.0
            echo ${SITL_RUN_SH}
            bash ${SITL_RUN_SH}

workflows:
  version: 2

  precision-landing-test:
    jobs: 
      - build-ros-ws
      - run-precision-landing-test:
          requires:
            - build-ros-ws

  
